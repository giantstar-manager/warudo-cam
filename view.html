<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Warudo Cam â€” ì˜ìƒ ë°›ê¸°</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Setup section (visible before connection) -->
  <div class="setup">
    <h1>ğŸ“º Warudo Cam â€” ì˜ìƒ ë°›ê¸°</h1>
    <p class="text-muted">ìƒëŒ€ë°©ì´ ë³´ë‚¸ ì—°ê²° ì½”ë“œë¥¼ ë¶™ì—¬ë„£ê³  ì—°ê²°í•˜ì„¸ìš”</p>

    <label>ìƒëŒ€ë°© ì—°ê²° ì½”ë“œ ë¶™ì—¬ë„£ê¸°</label>
    <textarea id="offerInput" rows="4" placeholder="ìƒëŒ€ë°©ì´ ë³´ë‚¸ ì—°ê²° ì½”ë“œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"></textarea>
    <button id="connect" class="btn btn-primary mt-8">ì—°ê²°</button>

    <div id="answerSection" style="display:none">
      <label>ì‘ë‹µ ì½”ë“œ (ìƒëŒ€ë°©ì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”)</label>
      <textarea id="answerCode" rows="4" readonly></textarea>
      <div class="gap-8 mt-8">
        <button id="copyAnswer" class="btn btn-success">ë³µì‚¬</button>
      </div>
    </div>

    <div id="status" class="status-indicator status-waiting mt-16">ëŒ€ê¸° ì¤‘</div>
  </div>

  <!-- Video (always present, fills screen when connected) -->
  <video id="remoteVideo" class="view-video" autoplay playsinline></video>

  <script src="lz-string.min.js"></script>
  <script src="rtc.js"></script>
  <script>
    (function () {
      var offerInput = document.getElementById('offerInput');
      var connectBtn = document.getElementById('connect');
      var answerSection = document.getElementById('answerSection');
      var answerCodeEl = document.getElementById('answerCode');
      var copyAnswerBtn = document.getElementById('copyAnswer');
      var remoteVideo = document.getElementById('remoteVideo');
      var statusEl = document.getElementById('status');

      // URL parameter support: auto-fill offer code
      var params = new URLSearchParams(window.location.search);
      var offerParam = params.get('offer');
      if (offerParam) {
        offerInput.value = offerParam;
      }

      // Remote track handler
      RTC.onRemoteTrack(function (stream) {
        remoteVideo.srcObject = stream;
      });

      // State change handler
      RTC.onStateChange(function (state) {
        var map = {
          'new':          { cls: 'status-waiting',      text: 'ëŒ€ê¸° ì¤‘' },
          'connecting':   { cls: 'status-connecting',   text: 'ì—°ê²° ì¤‘...' },
          'connected':    { cls: 'status-connected',    text: 'ì—°ê²°ë¨ âœ“' },
          'disconnected': { cls: 'status-disconnected', text: 'ì—°ê²° ëŠê¹€' },
          'failed':       { cls: 'status-disconnected', text: 'ì—°ê²° ì‹¤íŒ¨' }
        };

        var info = map[state];
        if (!info) return;

        statusEl.className = 'status-indicator ' + info.cls + ' mt-16';
        statusEl.textContent = info.text;

        if (state === 'connected') {
          document.body.classList.add('view-connected');
        }
      });

      // Connect button
      connectBtn.addEventListener('click', async function () {
        var code = offerInput.value.trim();
        if (!code) return;

        var offerSDP = LZString.decompressFromBase64(code);
        if (!offerSDP) {
          alert('ì˜¬ë°”ë¥¸ ì—°ê²° ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤');
          return;
        }

        try {
          RTC.createPeer(false);
          var answerSDP = await RTC.createAnswer(offerSDP);
          var answerCode = LZString.compressToBase64(answerSDP);

          answerCodeEl.value = answerCode;
          answerSection.style.display = '';
          connectBtn.disabled = true;
        } catch (e) {
          alert('ì˜¬ë°”ë¥¸ ì—°ê²° ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤');
        }
      });

      // Copy answer button
      copyAnswerBtn.addEventListener('click', function () {
        navigator.clipboard.writeText(answerCodeEl.value);
        copyAnswerBtn.textContent = 'ë³µì‚¬ë¨!';
        setTimeout(function () {
          copyAnswerBtn.textContent = 'ë³µì‚¬';
        }, 2000);
      });
    })();
  </script>
</body>
</html>
