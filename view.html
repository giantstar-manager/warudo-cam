<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Warudo Cam â€” ì˜ìƒ ë°›ê¸°</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <!-- Setup section (visible before connection) -->
  <div class="setup">
    <h1>ğŸ“º Warudo Cam â€” ì˜ìƒ ë°›ê¸°</h1>
    <p class="text-muted">ìƒëŒ€ë°©ì´ ë³´ë‚¸ ì—°ê²° ì½”ë“œë¥¼ ë¶™ì—¬ë„£ê³  ì—°ê²°í•˜ì„¸ìš”</p>

    <label for="codecSelect">ì½”ë± ì„ íƒ</label>
    <select id="codecSelect" class="mt-8 mb-16">
      <option value="vp9" selected>VP9 (ê¶Œì¥)</option>
      <option value="h264">H.264</option>
    </select>

    <label for="offerInput">ìƒëŒ€ë°© ì—°ê²° ì½”ë“œ ë¶™ì—¬ë„£ê¸°</label>
    <textarea id="offerInput" rows="4" placeholder="ìƒëŒ€ë°©ì´ ë³´ë‚¸ ì—°ê²° ì½”ë“œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"></textarea>
    <button id="connect" class="btn btn-primary mt-8" type="button">ì—°ê²°</button>

    <div id="answerSection" style="display:none">
      <label>ì‘ë‹µ ì½”ë“œ (ìƒëŒ€ë°©ì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”)</label>
      <textarea id="answerCode" rows="4" readonly></textarea>
      <div class="gap-8 mt-8">
        <button id="copyAnswer" class="btn btn-success" type="button">ë³µì‚¬</button>
      </div>
    </div>

    <div id="status" class="status-indicator status-waiting mt-16">ëŒ€ê¸° ì¤‘</div>
  </div>

  <!-- Video (always present, fills screen when connected) -->
  <video id="remoteVideo" class="view-video" autoplay playsinline>
    <track kind="captions" srclang="ko" label="ìë§‰" src="data:text/vtt,WEBVTT">
  </video>

  <div id="statsPanel" class="stats-panel" aria-live="polite">
    <div class="stats-item"><span>ë¹„íŠ¸ë ˆì´íŠ¸</span><strong id="statBitrate" class="stats-value">-</strong></div>
    <div class="stats-item"><span>í•´ìƒë„</span><strong id="statResolution" class="stats-value">-</strong></div>
    <div class="stats-item"><span>í”„ë ˆì„</span><strong id="statFps" class="stats-value">-</strong></div>
    <div class="stats-item"><span>íŒ¨í‚· ì†ì‹¤</span><strong id="statPacketLoss" class="stats-value">-</strong></div>
    <div class="stats-item"><span>ì½”ë±</span><strong id="statCodec" class="stats-value">-</strong></div>
    <div class="stats-item"><span>ì§€ì—°</span><strong id="statRtt" class="stats-value">-</strong></div>
  </div>

  <div id="enhancePanel" class="enhance-panel">
    <button id="enhanceToggle" class="enhance-gear" type="button" aria-expanded="false" aria-controls="enhanceContent">âš™</button>
      <div id="enhanceContent" class="enhance-content">
        <div class="enhance-row enhance-row-toggle">
          <label for="enhanceEnable">í™”ì§ˆ í–¥ìƒ</label>
          <input id="enhanceEnable" type="checkbox" checked>
        </div>
        <div class="enhance-section">í™”ì§ˆ</div>
        <div class="enhance-row">
          <label for="sharpnessRange">ì„ ëª…ë„</label>
          <input id="sharpnessRange" type="range" min="0" max="100" value="30">
          <span id="sharpnessValue" class="enhance-value">30%</span>
        </div>
      <div class="enhance-row">
        <label for="contrastRange">ëŒ€ë¹„</label>
        <input id="contrastRange" type="range" min="0.8" max="1.4" step="0.01" value="1.05">
        <span id="contrastValue" class="enhance-value">1.05</span>
      </div>
        <div class="enhance-row">
          <label for="saturationRange">ì±„ë„</label>
          <input id="saturationRange" type="range" min="0.8" max="1.4" step="0.01" value="1.10">
          <span id="saturationValue" class="enhance-value">1.10</span>
        </div>
        <div class="enhance-row">
          <label for="brightnessRange">ë°ê¸°</label>
          <input id="brightnessRange" type="range" min="0.5" max="2.0" step="0.01" value="1.00">
          <span id="brightnessValue" class="enhance-value">1.00</span>
        </div>
        <div class="enhance-row">
          <label for="gammaRange">ê°ë§ˆ</label>
          <input id="gammaRange" type="range" min="0.5" max="2.5" step="0.01" value="1.00">
          <span id="gammaValue" class="enhance-value">1.00</span>
        </div>
        <div class="enhance-section">ìƒ‰ìƒ</div>
        <div class="enhance-row">
          <label for="tempRange">ìƒ‰ì˜¨ë„</label>
          <input id="tempRange" type="range" min="-100" max="100" step="1" value="0">
          <span id="tempValue" class="enhance-value">0</span>
        </div>
        <div class="enhance-row">
          <label for="hueRange">ìƒ‰ìƒ íšŒì „</label>
          <input id="hueRange" type="range" min="-180" max="180" step="1" value="0">
          <span id="hueValue" class="enhance-value">0Â°</span>
        </div>
        <div class="enhance-section">ë³€í™˜</div>
        <div class="enhance-row">
          <label for="denoiseRange">ë…¸ì´ì¦ˆ ì œê±°</label>
          <input id="denoiseRange" type="range" min="0" max="3.0" step="0.1" value="0">
          <span id="denoiseValue" class="enhance-value">0px</span>
        </div>
        <div class="enhance-row enhance-row-check">
          <label for="flipEnable">ì¢Œìš° ë°˜ì „</label>
          <input id="flipEnable" type="checkbox">
        </div>
        <div class="enhance-row">
          <label for="zoomRange">í™•ëŒ€/ì¶•ì†Œ</label>
          <input id="zoomRange" type="range" min="1.0" max="3.0" step="0.01" value="1.00">
          <span id="zoomValue" class="enhance-value">1.00x</span>
        </div>
        <div class="enhance-row">
          <label for="opacityRange">ë¶ˆíˆ¬ëª…ë„</label>
          <input id="opacityRange" type="range" min="0" max="1.0" step="0.01" value="1.00">
          <span id="opacityValue" class="enhance-value">1.00</span>
        </div>
        <div class="enhance-section">ì´ˆê¸°í™”</div>
        <button id="enhanceReset" class="btn mt-8" type="button">ì´ˆê¸°í™”</button>
      </div>
    </div>

  <svg class="svg-filter-defs" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <filter id="warudoSharpen" x="-10%" y="-10%" width="120%" height="120%" color-interpolation-filters="sRGB">
      <feConvolveMatrix id="sharpenMatrix" order="3" kernelMatrix="0 0 0 0 1 0 0 0 0" preserveAlpha="true" edgeMode="duplicate"></feConvolveMatrix>
    </filter>
    <filter id="warudoGamma" x="-10%" y="-10%" width="120%" height="120%" color-interpolation-filters="sRGB">
      <feComponentTransfer>
        <feFuncR id="gammaFuncR" type="gamma" amplitude="1" exponent="1" offset="0"></feFuncR>
        <feFuncG id="gammaFuncG" type="gamma" amplitude="1" exponent="1" offset="0"></feFuncG>
        <feFuncB id="gammaFuncB" type="gamma" amplitude="1" exponent="1" offset="0"></feFuncB>
      </feComponentTransfer>
    </filter>
    <filter id="warudoTemp" x="-10%" y="-10%" width="120%" height="120%" color-interpolation-filters="sRGB">
      <feColorMatrix id="tempMatrix" type="matrix" values="1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0"></feColorMatrix>
    </filter>
  </svg>

  <script src="lz-string.min.js"></script>
  <script src="rtc.js"></script>
  <script>
    (function () {
      var offerInput = document.getElementById('offerInput');
      var codecSelect = document.getElementById('codecSelect');
      var connectBtn = document.getElementById('connect');
      var answerSection = document.getElementById('answerSection');
      var answerCodeEl = document.getElementById('answerCode');
      var copyAnswerBtn = document.getElementById('copyAnswer');
      var remoteVideo = document.getElementById('remoteVideo');
      var statusEl = document.getElementById('status');
      var statsPanel = document.getElementById('statsPanel');
      var statBitrate = document.getElementById('statBitrate');
      var statResolution = document.getElementById('statResolution');
      var statFps = document.getElementById('statFps');
      var statPacketLoss = document.getElementById('statPacketLoss');
      var statCodec = document.getElementById('statCodec');
      var statRtt = document.getElementById('statRtt');
      var enhancePanel = document.getElementById('enhancePanel');
      var enhanceToggle = document.getElementById('enhanceToggle');
      var enhanceContent = document.getElementById('enhanceContent');
      var enhanceEnable = document.getElementById('enhanceEnable');
      var sharpnessRange = document.getElementById('sharpnessRange');
      var contrastRange = document.getElementById('contrastRange');
      var saturationRange = document.getElementById('saturationRange');
      var brightnessRange = document.getElementById('brightnessRange');
      var gammaRange = document.getElementById('gammaRange');
      var tempRange = document.getElementById('tempRange');
      var hueRange = document.getElementById('hueRange');
      var denoiseRange = document.getElementById('denoiseRange');
      var flipEnable = document.getElementById('flipEnable');
      var zoomRange = document.getElementById('zoomRange');
      var opacityRange = document.getElementById('opacityRange');
      var sharpnessValue = document.getElementById('sharpnessValue');
      var contrastValue = document.getElementById('contrastValue');
      var saturationValue = document.getElementById('saturationValue');
      var brightnessValue = document.getElementById('brightnessValue');
      var gammaValue = document.getElementById('gammaValue');
      var tempValue = document.getElementById('tempValue');
      var hueValue = document.getElementById('hueValue');
      var denoiseValue = document.getElementById('denoiseValue');
      var zoomValue = document.getElementById('zoomValue');
      var opacityValue = document.getElementById('opacityValue');
      var enhanceReset = document.getElementById('enhanceReset');
      var sharpenMatrix = document.getElementById('sharpenMatrix');
      var gammaFuncR = document.getElementById('gammaFuncR');
      var gammaFuncG = document.getElementById('gammaFuncG');
      var gammaFuncB = document.getElementById('gammaFuncB');
      var tempMatrix = document.getElementById('tempMatrix');

      var reconnectAttempt = 0;
      var statsForcedVisible = false;

      function updateStatus(cls, text) {
        statusEl.className = 'status-indicator ' + cls + ' mt-16';
        statusEl.textContent = text;
      }

      function setQualityClass(el, metric, value) {
        var quality = 'stats-warn';
        if (metric === 'bitrate') {
          quality = value > 8 ? 'stats-good' : (value >= 4 ? 'stats-warn' : 'stats-bad');
        } else if (metric === 'packetLoss') {
          quality = value < 1 ? 'stats-good' : (value <= 5 ? 'stats-warn' : 'stats-bad');
        } else if (metric === 'fps') {
          quality = value >= 28 ? 'stats-good' : (value >= 20 ? 'stats-warn' : 'stats-bad');
        }
        el.className = 'stats-value ' + quality;
      }

      function renderStats(stats) {
        var bitrateMbps = (stats.bitrate || 0) / 1000000;
        var fps = stats.fps || 0;
        var packetLoss = stats.packetLoss || 0;
        var resolutionText = '-';
        if (stats.resolution && stats.resolution.w && stats.resolution.h) {
          resolutionText = stats.resolution.w + 'x' + stats.resolution.h;
        }

        statBitrate.textContent = bitrateMbps.toFixed(2) + ' Mbps';
        statResolution.textContent = resolutionText;
        statFps.textContent = fps.toFixed(1) + ' fps';
        statPacketLoss.textContent = packetLoss.toFixed(2) + '%';
        statCodec.textContent = (stats.codec || RTC.getConfig().codec || '-').toUpperCase();
        statRtt.textContent = (stats.roundTripTime || 0).toFixed(0) + ' ms';

        setQualityClass(statBitrate, 'bitrate', bitrateMbps);
        setQualityClass(statFps, 'fps', fps);
        setQualityClass(statPacketLoss, 'packetLoss', packetLoss);
      }

      function updateSharpenKernel() {
        var amount = Number(sharpnessRange.value) / 100;
        var diag = -(amount * 0.5);
        var card = -amount;
        var center = 1 + (6 * amount);
        var kernel = [
          diag, card, diag,
          card, center, card,
          diag, card, diag
        ].map(function (n) { return n.toFixed(3); }).join(' ');
        sharpenMatrix.setAttribute('kernelMatrix', kernel);
      }

      function updateGammaExponent() {
        var exponent = Number(gammaRange.value).toFixed(2);
        gammaFuncR.setAttribute('exponent', exponent);
        gammaFuncG.setAttribute('exponent', exponent);
        gammaFuncB.setAttribute('exponent', exponent);
      }

      function updateTempMatrixValues() {
        var tempValueRaw = Number(tempRange.value);
        var amount = Math.min(Math.abs(tempValueRaw) / 100, 1);
        var red = tempValueRaw >= 0 ? 1 + amount : 1 - amount;
        var blue = tempValueRaw >= 0 ? 1 - amount : 1 + amount;
        red = Math.max(0, Math.min(2, red));
        blue = Math.max(0, Math.min(2, blue));
        var matrixValues = [
          red.toFixed(3), '0', '0', '0', '0',
          '0', '1.000', '0', '0', '0',
          '0', '0', blue.toFixed(3), '0', '0',
          '0', '0', '0', '1', '0'
        ].join(' ');
        tempMatrix.setAttribute('values', matrixValues);
      }

      function applyEnhancement() {
        var sharpness = Number(sharpnessRange.value);
        var contrast = Number(contrastRange.value);
        var saturation = Number(saturationRange.value);
        var brightness = Number(brightnessRange.value);
        var gamma = Number(gammaRange.value);
        var temp = Number(tempRange.value);
        var hue = Number(hueRange.value);
        var denoise = Number(denoiseRange.value);
        var zoom = Number(zoomRange.value);
        var opacity = Number(opacityRange.value);

        sharpnessValue.textContent = sharpnessRange.value + '%';
        contrastValue.textContent = contrast.toFixed(2);
        saturationValue.textContent = saturation.toFixed(2);
        brightnessValue.textContent = brightness.toFixed(2);
        gammaValue.textContent = gamma.toFixed(2);
        tempValue.textContent = String(temp);
        hueValue.textContent = String(hue) + 'Â°';
        denoiseValue.textContent = (denoise % 1 === 0 ? denoise.toFixed(0) : denoise.toFixed(1)) + 'px';
        zoomValue.textContent = zoom.toFixed(2) + 'x';
        opacityValue.textContent = opacity.toFixed(2);

        if (!enhanceEnable.checked) {
          remoteVideo.style.filter = 'none';
          remoteVideo.style.transform = '';
          remoteVideo.style.opacity = '';
          return;
        }

        var filters = [];

        if (sharpness > 0) {
          updateSharpenKernel();
          filters.push('url(#warudoSharpen)');
        }

        if (gamma !== 1) {
          updateGammaExponent();
          filters.push('url(#warudoGamma)');
        }

        if (temp !== 0) {
          updateTempMatrixValues();
          filters.push('url(#warudoTemp)');
        }

        if (brightness !== 1) {
          filters.push('brightness(' + brightness.toFixed(2) + ')');
        }

        if (contrast !== 1) {
          filters.push('contrast(' + contrast.toFixed(2) + ')');
        }

        if (saturation !== 1) {
          filters.push('saturate(' + saturation.toFixed(2) + ')');
        }

        if (hue !== 0) {
          filters.push('hue-rotate(' + hue + 'deg)');
        }

        if (denoise > 0) {
          filters.push('blur(' + denoise.toFixed(1) + 'px)');
        }

        if (opacity !== 1) {
          filters.push('opacity(' + opacity.toFixed(2) + ')');
        }

        var transforms = [];
        if (zoom !== 1) {
          transforms.push('scale(' + zoom.toFixed(2) + ')');
        }
        if (flipEnable.checked) {
          transforms.push('scaleX(-1)');
        }

        remoteVideo.style.filter = filters.length ? filters.join(' ') : 'none';
        remoteVideo.style.transform = transforms.length ? transforms.join(' ') : '';
        remoteVideo.style.opacity = '';
      }

      function toggleEnhancePanel(forceOpen) {
        var isOpen = typeof forceOpen === 'boolean' ? forceOpen : !enhancePanel.classList.contains('open');
        enhancePanel.classList.toggle('open', isOpen);
        enhanceToggle.setAttribute('aria-expanded', String(isOpen));
        enhanceContent.hidden = !isOpen;
      }

      RTC.configure({ codec: codecSelect.value });

      codecSelect.addEventListener('change', function () {
        RTC.configure({ codec: codecSelect.value });
      });

      enhanceToggle.addEventListener('click', function () {
        toggleEnhancePanel();
      });

      [
        enhanceEnable,
        sharpnessRange,
        contrastRange,
        saturationRange,
        brightnessRange,
        gammaRange,
        tempRange,
        hueRange,
        denoiseRange,
        flipEnable,
        zoomRange,
        opacityRange
      ].forEach(function (el) {
        el.addEventListener('input', applyEnhancement);
      });

      enhanceReset.addEventListener('click', function () {
        enhanceEnable.checked = true;
        sharpnessRange.value = '30';
        contrastRange.value = '1.05';
        saturationRange.value = '1.10';
        brightnessRange.value = '1.00';
        gammaRange.value = '1.00';
        tempRange.value = '0';
        hueRange.value = '0';
        denoiseRange.value = '0';
        flipEnable.checked = false;
        zoomRange.value = '1.00';
        opacityRange.value = '1.00';
        applyEnhancement();
      });

      document.addEventListener('keydown', function (event) {
        if (event.key && event.key.toLowerCase() === 's') {
          statsForcedVisible = !statsForcedVisible;
          document.body.classList.toggle('stats-force-visible', statsForcedVisible);
        }
      });

      RTC.onStats(function (stats) {
        renderStats(stats);
      });

      RTC.onReconnect(function () {
        reconnectAttempt += 1;
        updateStatus('status-connecting', 'ì¬ì—°ê²° ì‹œë„ ì¤‘... (' + reconnectAttempt + '/3)');
      });

      RTC.onReconnectFailed(function () {
        updateStatus('status-disconnected', 'ì¬ì—°ê²° ì‹¤íŒ¨');
      });

      // URL parameter support: auto-fill offer code
      var params = new URLSearchParams(window.location.search);
      var offerParam = params.get('offer');
      if (offerParam) {
        offerInput.value = offerParam;
      }

      // Remote track handler
      RTC.onRemoteTrack(function (stream) {
        remoteVideo.srcObject = stream;
        applyEnhancement();
      });

      // State change handler
      RTC.onStateChange(function (state) {
        var map = {
          'new':          { cls: 'status-waiting',      text: 'ëŒ€ê¸° ì¤‘' },
          'connecting':   { cls: 'status-connecting',   text: 'ì—°ê²° ì¤‘...' },
          'connected':    { cls: 'status-connected',    text: 'ì—°ê²°ë¨ âœ“' },
          'disconnected': { cls: 'status-disconnected', text: 'ì—°ê²° ëŠê¹€' },
          'failed':       { cls: 'status-disconnected', text: 'ì—°ê²° ì‹¤íŒ¨' }
        };

        var info = map[state];
        if (!info) return;

        updateStatus(info.cls, info.text);

        if (state === 'connected') {
          reconnectAttempt = 0;
          document.body.classList.add('view-connected');
          statsPanel.classList.add('stats-visible');
          RTC.startStats(2000);
        } else if (state === 'disconnected' || state === 'failed' || state === 'closed') {
          RTC.stopStats();
          statsPanel.classList.remove('stats-visible');
        }
      });

      // Connect button
      connectBtn.addEventListener('click', async function () {
        var code = offerInput.value.trim();
        var answerSDP;
        var answerCode;
        if (!code) return;

        var offerSDP = LZString.decompressFromBase64(code);
        if (!offerSDP) {
          alert('ì˜¬ë°”ë¥¸ ì—°ê²° ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤');
          return;
        }

        try {
          RTC.createPeer(false);
          answerSDP = await RTC.createAnswer(offerSDP);
          answerCode = LZString.compressToBase64(answerSDP);

          answerCodeEl.value = answerCode;
          answerSection.style.display = '';
          connectBtn.disabled = true;
        } catch (e) {
          alert('ì˜¬ë°”ë¥¸ ì—°ê²° ì½”ë“œê°€ ì•„ë‹™ë‹ˆë‹¤');
        }
      });

      // Copy answer button
      copyAnswerBtn.addEventListener('click', function () {
        navigator.clipboard.writeText(answerCodeEl.value);
        copyAnswerBtn.textContent = 'ë³µì‚¬ë¨!';
        setTimeout(function () {
          copyAnswerBtn.textContent = 'ë³µì‚¬';
        }, 2000);
      });

      toggleEnhancePanel(false);
      applyEnhancement();
    })();
  </script>
</body>
</html>
