<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Warudo Cam â€” ì˜ìƒ ë³´ë‚´ê¸°</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <!-- Header -->
    <h1>ğŸ¥ Warudo Cam</h1>
    <p class="text-muted">Warudo ì•„ë°”íƒ€ ì˜ìƒì„ ìƒëŒ€ë°© OBSë¡œ ì „ì†¡í•©ë‹ˆë‹¤</p>

    <!-- Step 1: Camera Selection -->
    <div class="mb-16">
      <label for="cameraSelect">ì¹´ë©”ë¼ ì„ íƒ</label>
      <select id="cameraSelect" class="mt-8"></select>
    </div>

    <div class="mb-16">
      <label for="codecSelect">ì½”ë± ì„ íƒ</label>
      <select id="codecSelect" class="mt-8">
        <option value="vp9" selected>VP9 (ê¶Œì¥)</option>
        <option value="h264">H.264</option>
      </select>
    </div>

    <video id="preview" class="push-preview mt-8 mb-16" autoplay muted playsinline></video>

    <!-- Step 2: Generate Offer Code -->
    <button id="createOffer" class="btn btn-primary mb-16" type="button">ì—°ê²° ì½”ë“œ ìƒì„±</button>

    <div id="offerSection" class="mb-16" style="display:none">
      <label for="offerCode">ì—°ê²° ì½”ë“œ (ìƒëŒ€ë°©ì—ê²Œ ì „ë‹¬í•˜ì„¸ìš”)</label>
      <textarea id="offerCode" class="mt-8" rows="4" readonly></textarea>
      <button id="copyOffer" class="btn btn-success mt-8" type="button">ë³µì‚¬</button>
    </div>

    <!-- Step 3: Paste Answer Code -->
    <div id="answerSection" class="mb-16" style="display:none">
      <label for="answerInput">ìƒëŒ€ë°© ì‘ë‹µ ì½”ë“œ ë¶™ì—¬ë„£ê¸°</label>
      <textarea id="answerInput" class="mt-8" rows="4" placeholder="ìƒëŒ€ë°©ì´ ë³´ë‚¸ ì‘ë‹µ ì½”ë“œë¥¼ ì—¬ê¸°ì— ë¶™ì—¬ë„£ìœ¼ì„¸ìš”"></textarea>
      <button id="applyAnswer" class="btn btn-primary mt-8" type="button">ì—°ê²°</button>
    </div>

    <!-- Status display -->
    <div id="status" class="status-indicator status-waiting mt-16">ëŒ€ê¸° ì¤‘</div>
    <div id="statsPanel" class="stats-panel stats-inline mt-8" aria-live="polite">
      <div class="stats-item"><span>ë¹„íŠ¸ë ˆì´íŠ¸</span><strong id="statBitrate" class="stats-value">-</strong></div>
      <div class="stats-item"><span>í•´ìƒë„</span><strong id="statResolution" class="stats-value">-</strong></div>
      <div class="stats-item"><span>í”„ë ˆì„</span><strong id="statFps" class="stats-value">-</strong></div>
      <div class="stats-item"><span>íŒ¨í‚· ì†ì‹¤</span><strong id="statPacketLoss" class="stats-value">-</strong></div>
      <div class="stats-item"><span>ì½”ë±</span><strong id="statCodec" class="stats-value">-</strong></div>
      <div class="stats-item"><span>ì§€ì—°</span><strong id="statRtt" class="stats-value">-</strong></div>
    </div>
  </div>

  <script src="lz-string.min.js"></script>
  <script src="rtc.js"></script>
  <script>
    (function () {
      var cameraSelect = document.getElementById('cameraSelect');
      var codecSelect = document.getElementById('codecSelect');
      var preview = document.getElementById('preview');
      var createOfferBtn = document.getElementById('createOffer');
      var offerSection = document.getElementById('offerSection');
      var offerCode = document.getElementById('offerCode');
      var copyOfferBtn = document.getElementById('copyOffer');
      var answerSection = document.getElementById('answerSection');
      var answerInput = document.getElementById('answerInput');
      var applyAnswerBtn = document.getElementById('applyAnswer');
      var statusEl = document.getElementById('status');
      var statsPanel = document.getElementById('statsPanel');
      var statBitrate = document.getElementById('statBitrate');
      var statResolution = document.getElementById('statResolution');
      var statFps = document.getElementById('statFps');
      var statPacketLoss = document.getElementById('statPacketLoss');
      var statCodec = document.getElementById('statCodec');
      var statRtt = document.getElementById('statRtt');

      var currentStream = null;
      var reconnectAttempt = 0;

      function updateStatus(cls, text) {
        statusEl.className = 'status-indicator ' + cls + ' mt-16';
        statusEl.textContent = text;
      }

      function toMbps(value) {
        if (!value || value < 0) return '0.00 Mbps';
        return (value / 1000000).toFixed(2) + ' Mbps';
      }

      function setQualityClass(el, metric, value) {
        var quality = 'stats-warn';
        if (metric === 'bitrate') {
          quality = value > 8 ? 'stats-good' : (value >= 4 ? 'stats-warn' : 'stats-bad');
        } else if (metric === 'packetLoss') {
          quality = value < 1 ? 'stats-good' : (value <= 5 ? 'stats-warn' : 'stats-bad');
        } else if (metric === 'fps') {
          quality = value >= 28 ? 'stats-good' : (value >= 20 ? 'stats-warn' : 'stats-bad');
        }
        el.className = 'stats-value ' + quality;
      }

      function renderStats(stats) {
        var bitrateMbps = (stats.bitrate || 0) / 1000000;
        var fps = stats.fps || 0;
        var packetLoss = stats.packetLoss || 0;
        var resolutionText = '-';
        if (stats.resolution && stats.resolution.w && stats.resolution.h) {
          resolutionText = stats.resolution.w + 'x' + stats.resolution.h;
        }

        statBitrate.textContent = toMbps(stats.bitrate || 0);
        statResolution.textContent = resolutionText;
        statFps.textContent = fps.toFixed(1) + ' fps';
        statPacketLoss.textContent = packetLoss.toFixed(2) + '%';
        statCodec.textContent = (stats.codec || RTC.getConfig().codec || '-').toUpperCase();
        statRtt.textContent = ((stats.roundTripTime || 0).toFixed(0)) + ' ms';

        setQualityClass(statBitrate, 'bitrate', bitrateMbps);
        setQualityClass(statFps, 'fps', fps);
        setQualityClass(statPacketLoss, 'packetLoss', packetLoss);
      }

      RTC.onStats(function (stats) {
        renderStats(stats);
      });

      RTC.onReconnect(function () {
        reconnectAttempt += 1;
        updateStatus('status-connecting', 'ì¬ì—°ê²° ì‹œë„ ì¤‘... (' + reconnectAttempt + '/3)');
      });

      RTC.onReconnectFailed(function () {
        updateStatus('status-disconnected', 'ì¬ì—°ê²° ì‹¤íŒ¨');
      });

      // --- Camera listing & preview ---

      function populateCameras() {
        RTC.listCameras().then(function (cameras) {
          var opt;
          cameraSelect.innerHTML = '';

          if (!cameras || cameras.length === 0) {
            opt = document.createElement('option');
            opt.textContent = 'ì¹´ë©”ë¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
            opt.disabled = true;
            cameraSelect.appendChild(opt);
            return;
          }

          cameras.forEach(function (cam, i) {
            var opt = document.createElement('option');
            opt.value = cam.deviceId;
            opt.textContent = cam.label || 'ì¹´ë©”ë¼ ' + (i + 1);
            cameraSelect.appendChild(opt);
          });

          startPreview(cameras[0].deviceId);
        }).catch(function (err) {
          alert('ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤');
        });
      }

      function startPreview(deviceId) {
        if (currentStream) {
          currentStream.getTracks().forEach(function (t) { t.stop(); });
        }

        RTC.getCamera(deviceId).then(function (stream) {
          currentStream = stream;
          preview.srcObject = stream;
        }).catch(function (err) {
          alert('ì¹´ë©”ë¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤');
        });
      }

      cameraSelect.addEventListener('change', function () {
        startPreview(cameraSelect.value);
      });

      codecSelect.addEventListener('change', function () {
        RTC.configure({ codec: codecSelect.value });
      });

      RTC.configure({ codec: codecSelect.value });

      // --- Offer creation ---

      createOfferBtn.addEventListener('click', function () {
        if (!currentStream) {
          alert('ì¹´ë©”ë¼ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
          return;
        }

        createOfferBtn.disabled = true;
        createOfferBtn.textContent = 'ìƒì„± ì¤‘...';

        RTC.createPeer(true, currentStream);

        RTC.createOffer().then(function (sdp) {
          var code = LZString.compressToBase64(sdp);
          offerCode.value = code;
          offerSection.style.display = '';
          answerSection.style.display = '';
          createOfferBtn.disabled = false;
          createOfferBtn.textContent = 'ì¬ìƒì„±';
        }).catch(function (err) {
          alert('ì—°ê²° ì½”ë“œ ìƒì„± ì‹¤íŒ¨: ' + err.message);
          createOfferBtn.disabled = false;
          createOfferBtn.textContent = 'ì—°ê²° ì½”ë“œ ìƒì„±';
        });
      });

      // --- Copy offer ---

      copyOfferBtn.addEventListener('click', function () {
        navigator.clipboard.writeText(offerCode.value).then(function () {
          copyOfferBtn.textContent = 'ë³µì‚¬ë¨!';
          setTimeout(function () { copyOfferBtn.textContent = 'ë³µì‚¬'; }, 2000);
        });
      });

      // --- Apply answer ---

      applyAnswerBtn.addEventListener('click', function () {
        var answerCode = answerInput.value.trim();
        if (!answerCode) return;

        var answerSDP = LZString.decompressFromBase64(answerCode);
        RTC.setRemoteAnswer(answerSDP).catch(function (err) {
          alert('ì‘ë‹µ ì½”ë“œ ì ìš© ì‹¤íŒ¨: ' + err.message);
        });
      });

      // --- State change ---

      var stateMap = {
        'new':          { cls: 'status-waiting',      text: 'ëŒ€ê¸° ì¤‘' },
        'connecting':   { cls: 'status-connecting',   text: 'ì—°ê²° ì¤‘...' },
        'connected':    { cls: 'status-connected',    text: 'ì—°ê²°ë¨ âœ“' },
        'disconnected': { cls: 'status-disconnected', text: 'ì—°ê²° ëŠê¹€' },
        'failed':       { cls: 'status-disconnected', text: 'ì—°ê²° ì‹¤íŒ¨' },
        'closed':       { cls: 'status-waiting',      text: 'ì¢…ë£Œë¨' }
      };

      RTC.onStateChange(function (state) {
        var info = stateMap[state];
        if (!info) return;

        updateStatus(info.cls, info.text);

        if (state === 'connected') {
          reconnectAttempt = 0;
          statsPanel.classList.add('stats-visible');
          RTC.startStats(2000);
        } else if (state === 'disconnected' || state === 'failed' || state === 'closed') {
          RTC.stopStats();
          statsPanel.classList.remove('stats-visible');
        }
      });

      // --- Init ---
      populateCameras();
    })();
  </script>
</body>
</html>
